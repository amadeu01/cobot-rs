# Project Organization and Structure

This document explains the complete organization of the Cobot-RS project, from directory structure to CI/CD workflows.

## Overview

Cobot-RS follows professional Rust project organization principles with a focus on embedded development, comprehensive testing, and automated quality assurance.

## Directory Structure

```
cobot-rs/
├── .github/
│   └── workflows/           # GitHub Actions CI/CD
│       ├── ci.yml          # Full CI pipeline (ESP32 build)
│       └── core.yml        # Core CI pipeline (host-only tests)
├── .cargo/
│   └── config.toml         # Cargo configuration for ESP32
├── assets/
│   └── banner.png          # Project banner image
├── build/                  # Compiled test binaries (git-ignored)
│   └── servo_math          # Generated by test scripts
├── docs/
│   ├── how_to_run.md       # Setup and deployment guide
│   ├── testing.md          # Testing strategy and documentation
│   └── project_organization.md # This file
├── scripts/
│   ├── test.sh             # Convenient test runner
│   └── setup.sh            # Project setup automation
├── src/
│   ├── main.rs             # ESP32 main application
│   └── servo_controller.rs # Servo control logic + embedded tests
├── tests/
│   ├── servo_math.rs       # Host-based mathematical function tests
│   └── README.md           # Testing documentation
├── target/                 # Cargo build artifacts (git-ignored)
├── .gitignore              # Git ignore rules
├── Cargo.toml              # Project dependencies and configuration
├── README-template.md      # Template for new contributors
├── readme.md               # Main project documentation
└── rust-toolchain.toml     # Rust toolchain specification
```

## Key Organizational Principles

### 1. **Separation of Concerns**
- **`src/`**: ESP32-specific code that requires hardware
- **`tests/`**: Host-runnable tests for mathematical functions
- **`scripts/`**: Build and automation scripts
- **`docs/`**: All documentation

### 2. **CI-Friendly Structure**
- Tests can run without ESP32 hardware in CI environments
- Automated quality checks (formatting, linting, testing)
- Multiple CI workflows for different validation levels

### 3. **Developer Experience**
- **`./scripts/test.sh`**: One command for all testing needs
- **`./scripts/setup.sh`**: Automated environment setup
- **Clear documentation**: Every directory has purpose and documentation

### 4. **Professional Standards**
- **Git ignore patterns**: No compiled binaries in version control
- **Build directory**: Organized output location for compiled artifacts
- **Comprehensive CI**: Multiple validation layers

## File Organization Details

### Source Code (`src/`)

**`main.rs`**
- ESP32 application entry point
- Hardware initialization
- Main control loop
- GPIO pin assignments

**`servo_controller.rs`**
- Mathematical functions (angle_to_duty, duty_to_angle, etc.)
- Hardware abstraction for servo control
- Robot behavior patterns (walking, waving)
- Embedded unit tests (run on ESP32)

### Tests (`tests/`)

**`servo_math.rs`**
- Standalone mathematical function tests
- No ESP32 dependencies - runs on any system
- Comprehensive test coverage (10+ test functions)
- Visual demonstration capabilities

**Key Features:**
- Tests the same functions used in production
- Runs in milliseconds (instant feedback)
- Works in CI environments
- Educational visual output

### Scripts (`scripts/`)

**`test.sh`**
- Unified test runner with multiple modes
- Handles build directory management
- Provides colored output and error handling
- Works from project root or scripts directory

**`setup.sh`**
- Automated project setup
- Dependency checking (Rust, Git, ESP32 tools)
- Directory creation and permission setup
- Git repository configuration guidance

### Documentation (`docs/`)

**`how_to_run.md`**
- Complete setup and deployment guide
- Testing instructions
- Troubleshooting section
- Development workflow

**`testing.md`**
- Detailed testing strategy explanation
- Test architecture documentation
- Adding new tests guide
- Performance considerations

**`project_organization.md`** (this file)
- Complete project structure explanation
- Organizational principles
- Maintenance guidelines

## Git Configuration

### `.gitignore` Patterns
```gitignore
# Build outputs
build/
target/

# Compiled binaries
*.exe
test_*
servo_*

# ESP32 build files
/.embuild
```

### Branch Strategy
- **`main`**: Stable, deployable code
- **`develop`**: Integration branch for features
- **Feature branches**: Individual development work

## CI/CD Workflows

### Core CI Pipeline (`core.yml`)
**Purpose**: Fast validation that runs on every push

**Jobs:**
1. **Mathematical Tests**: Validate core calculations
2. **Code Quality**: Formatting and linting checks
3. **Script Validation**: Test runner functionality
4. **Documentation**: Link validation and structure
5. **Project Structure**: Directory organization validation

**Duration**: ~2-3 minutes
**Hardware Requirements**: None (runs on GitHub runners)

### Full CI Pipeline (`ci.yml`)
**Purpose**: Comprehensive validation including ESP32 build

**Jobs:**
1. **Lint**: Code formatting and clippy analysis
2. **Test Math**: Mathematical function validation
3. **Build ESP32**: Actual ESP32 target compilation
4. **Check Docs**: Documentation completeness
5. **Security Audit**: Dependency vulnerability scanning
6. **Check Scripts**: Shell script validation

**Duration**: ~10-15 minutes
**Hardware Requirements**: ESP32 toolchain setup

## Build System

### Cargo Configuration
- **Target**: `xtensa-esp32-espidf`
- **Runner**: `espflash flash --monitor`
- **Optimization**: Size-optimized builds (`opt-level = "s"`)

### Test Compilation
- **Host tests**: Standard Rust compilation (`rustc`)
- **Embedded tests**: ESP32 cross-compilation (`cargo test`)
- **Build artifacts**: Isolated in `build/` directory

## Maintenance Guidelines

### Adding New Features

1. **Write mathematical functions first** in `tests/servo_math.rs`
2. **Test thoroughly** with `./scripts/test.sh`
3. **Implement in ESP32 code** in `src/servo_controller.rs`
4. **Add embedded tests** for hardware integration
5. **Update documentation** as needed

### Code Quality Standards

1. **Formatting**: `cargo fmt --all`
2. **Linting**: Address clippy warnings
3. **Testing**: Maintain test coverage
4. **Documentation**: Update relevant docs
5. **CI**: Ensure all checks pass

### Release Process

1. **Develop**: Work in feature branches
2. **Test**: Comprehensive local testing
3. **Review**: Pull request review process
4. **CI**: Automated validation
5. **Merge**: Integration to main branch
6. **Deploy**: Release to ESP32 hardware

## Performance Considerations

### Test Execution Speed
- **Host tests**: ~50ms execution time
- **ESP32 tests**: ~30s including flash time
- **CI pipeline**: ~2-3 minutes for core validation

### Build Artifact Management
- **Build directory**: Automated cleanup available
- **Git ignore**: Prevents accidental commits
- **CI caching**: Optimized dependency handling

## Security and Best Practices

### Dependency Management
- **Cargo audit**: Automated vulnerability scanning
- **Minimal dependencies**: Only essential crates
- **Version pinning**: Stable, tested versions

### Secret Management
- **No hardcoded secrets**: Use environment variables
- **Git ignore**: Sensitive files excluded
- **CI variables**: Secure handling in workflows

## Future Scalability

### Adding Hardware Support
1. **Abstract hardware interfaces** in servo_controller.rs
2. **Add new target configurations** in Cargo.toml
3. **Create hardware-specific tests** in tests/
4. **Update CI workflows** for new targets

### Expanding Test Coverage
1. **Add test files** in tests/ directory
2. **Update test script** to handle new tests
3. **Document testing approach** in testing.md
4. **Ensure CI integration** covers new tests

## Troubleshooting Common Issues

### Build Problems
- **Missing dependencies**: Run `./scripts/setup.sh`
- **Wrong directory**: Ensure running from project root
- **ESP32 toolchain**: Check ESP32 Rust installation

### Test Failures
- **Mathematical precision**: Some rounding errors are expected
- **Missing files**: Verify project structure integrity
- **Permission errors**: Ensure scripts are executable

### CI Failures
- **Badge URLs**: Update GitHub username in README
- **Workflow permissions**: Check repository settings
- **Secret variables**: Verify CI environment setup

## Summary

The Cobot-RS project organization balances several key requirements:

- **Development Speed**: Instant feedback through host-based tests
- **Hardware Validation**: Embedded tests for ESP32 verification  
- **Professional Quality**: Comprehensive CI/CD and documentation
- **Maintainability**: Clear structure and automated tooling
- **Scalability**: Organized for future expansion

This structure enables rapid development cycles while maintaining high quality standards and supporting both novice and expert contributors.